%% Mermaid sequence diagram - Very detailed
%% File: diagrams/sequences/recepcion.mmd
sequenceDiagram
  participant FE as Frontend (SPA)
  participant Proxy as Traefik/Nginx
  participant API as FastAPI (Auth middleware + LotesController)
  participant Auth as Auth Dependency (`get_current_user`)
  participant Scope as Scope Helper (`get_user_scope`)
  participant Bodega as DB/Bodega Row (Postgres)
  participant DB as Postgres
  participant Cache as Redis Cache
  participant Auditoria as Auditoria Service / Table

  Note over FE,Proxy: User triggers "RecepciÃ³n" form submit with Bearer token
  FE->>Proxy: POST /api/v1/lotes/recepcion (Authorization: Bearer <token>)
  Proxy->>API: Forward request

  alt Auth
    API->>Auth: Decode & validate token (`jwt.decode`)
    Auth-->>API: current_user (or 401/403)
  end

  API->>Scope: get_user_scope(current_user)
  Scope-->>API: scope (None for admin or {id_sucursal: N})

  Note over API,Bodega: Start transaction for reception
  API->>Bodega: SELECT * FROM bodegas WHERE id = X FOR UPDATE  -- lock row
  Bodega->>DB: Acquire row-level lock, return bodega record

  API->>DB: SUM existing occupation for bodega X (SELECT SUM(cantidad) FROM productos WHERE id_bodega = X)
  DB-->>API: current_occupacion

  API->>API: calcular nueva ocupacion = current_occupacion + requested_cantidad
  alt Enough capacity
    API->>DB: INSERT lote, INSERT productos, INSERT movimientos (inside transaction)
    DB-->>API: confirm inserts
    API->>Auditoria: write audit record (lote created, user, timestamp)
    API->>Cache: invalidate keys (lotes:*, bodegas:stats, productos:list)
    Cache-->>API: ok
    API->>Proxy: commit transaction
    API-->>FE: 200 Created + created lote + product ids
  else Capacity exceeded
    API->>DB: Query other bodegas in same sucursal for available capacity
    DB-->>API: list of candidate bodegas with capacities
    API->>API: run sugerir_distribucion_automatica algorithm (greedy)
    alt Distribution possible
      API-->>FE: 409 Conflict + { error: capacidad_insuficiente, sugerencias_distribucion }
    else No distribution possible
      API-->>FE: 409 Conflict + { error: capacidad_insuficiente_sucursal }
    end
  end

  Note over FE,API: End
